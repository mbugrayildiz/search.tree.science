<html>
    <head>
        <title>search.tree.science</title>
        <link rel="stylesheet"
          href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/default.min.css">
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script>
    </head>
    <body>
        <center>
            <h2>search.tree.science</h2>
            Search Engine, but for code!
        </center>
        <form name="fetch">
          <center><input type="text" name="query" style="width: 30rem; height: 10rem;" value="FunctionDef(body={Return(Tuple())})"></center>
          <center><button type="submit">Submit</button></center>
          <a href="https://github.com/reizio/reiz.io/blob/master/docs/reizql.md">ReizQL docs</a>
        </form>
        <span id="stats" style="float:right;padding-right:10rem;"></span><br><br>
        <div id="errors"></div>
        <div id="results"></div>
    </body>
    <script>
        const form = document.forms.fetch;
        const stats_box = document.getElementById("stats");

        const handleSubmit = async (e) => {
            e.preventDefault();
            const element = e.target.firstElementChild.firstElementChild;
            const body = JSON.stringify({
                query: element.value || element.placeholder,
            });
            const stats_body = JSON.stringify({
                query: element.value || element.placeholder,
                stats: true,
            });
            stats_box.innerHTML.innerHTML = "";
            const res = await postForm(body);
            const data = await res.json();
            document.getElementById("results").innerHTML = "";
            document.getElementById("errors").innerHTML = "";
            if (data.status == "success") {
                for (result of data.results) {
                    let container = document.createElement("fieldset");
                    let filename_box = document.createElement("legend");
                    filename_box.innerHTML = result.filename;
                    container.appendChild(filename_box);
                    let outer_code_box = document.createElement("pre");
                    let inner_code_box = document.createElement("code");
                    inner_code_box.className = "python hljs";
                    let code_box = document.createTextNode(result.source);
                    inner_code_box.appendChild(code_box);
                    outer_code_box.appendChild(inner_code_box);
                    container.appendChild(outer_code_box);
                    document.getElementById("results").appendChild(container);
                }
                document.querySelectorAll("code").forEach((block) => {
                    hljs.highlightBlock(block);
                });
                const res_stats = await postForm(stats_body);
                const stats_data = await res_stats.json();
                if (stats_data.status == "success") {
                    stats_box.innerHTML = "Total number of matches: " + stats_data.results;
                }
            } else {
                document.getElementById("errors").innerHTML = data.exception;
            }
        };

        const postForm = (body) => {
            return fetch("https://api.tree.science/query", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body,
            });
        };

        form.addEventListener("submit", handleSubmit);
    </script>
</html>
